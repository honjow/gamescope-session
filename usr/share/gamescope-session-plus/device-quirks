# This file will be sourced by gamescope-session script if not
# overridden in ~/.config/environment.d

# grep -H . /sys/class/drm/card*-*/status | grep :connected

# This file would be sourced by gamescope-session script (meant for
# ChimeraOS devices).
export LANG=en_US.UTF-8
SYS_ID="$(cat /sys/class/dmi/id/product_name)"
CPU_VENDOR=$(cat /proc/cpuinfo | grep vendor_id | head -n 1 | cut -d : -f 2 | xargs)
CPU_MODEL=$(cat /proc/cpuinfo | grep "model name" | head -n 1 | cut -d : -f 2 | xargs)
SYS_ID="$(cat /sys/devices/virtual/dmi/id/product_name)"
CPU_VENDOR="$(lscpu | grep "Vendor ID" | cut -d : -f 2 | xargs)"

SCRIPTS_DIR="/usr/share/gamescope/scripts/"

function lua_not_exists() {
  # 返回值 1:存在 0:不存在
  local dir=${2:-$SCRIPTS_DIR}
  local file=$1
  files=$(find $dir -name $file -type f 2>/dev/null)
  if [ -n "$files" ]; then
    return 1
  else
    return 0
  fi
}

# OXP 60Hz Devices
OXP_LIST="ONE XPLAYER:ONEXPLAYER 1 T08:ONEXPLAYER 1S A08:ONEXPLAYER 1S T08:ONEXPLAYER mini A07:ONEXPLAYER mini GA72:ONEXPLAYER mini GT72:ONEXPLAYER Mini Pro:ONEXPLAYER GUNDAM GA72:ONEXPLAYER 2 ARP23:ONEXPLAYER 2 PRO ARP23H:ONEXPLAYER 2 PRO ARP23P:ONEXPLAYER 2 PRO ARP23P EVA-01"
AOK_LIST="AOKZOE A1 AR07:AOKZOE A1 Pro:AOKZOE A2 Pro"
if [[ ":$OXP_LIST:" =~ ":$SYS_ID:"  ]] || [[  ":$AOK_LIST:" =~ ":$SYS_ID:"   ]]; then
  DRM_MODE=fixed
  # PANEL_TYPE=external
  ORIENTATION=left
  CUSTOM_REFRESH_RATES=40-60

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=40,60
fi

# OXP 120Hz Devices
# OXP_120_LIST="ONEXPLAYER F1"
# if [[ ":$OXP_120_LIST:" =~ ":$SYS_ID:"  ]]; then
#   # PANEL_TYPE=external
#   ORIENTATION=left
#   if [[ ! -f "${SCRIPTS_DISPLAY_DIR}/onexplayer.fly.lcd.lua" ]]; then
#     DRM_MODE=custom
#     DRM_MODE_CUSTOM_DIR=/usr/share/gamescope-session-plus/modelines
#   fi

#   # Set refresh rate range and enable refresh rate switching
#   export STEAM_DISPLAY_REFRESH_LIMITS=40,120
# fi

# OXP Fly
if [[ "$SYS_ID" =~ "ONEXPLAYER F1" ]]; then
  # PANEL_TYPE=external
  ORIENTATION=left
  # if [[ ! -f "${SCRIPTS_DISPLAY_DIR}/onexplayer.fly.lcd.lua" ]]; then
  #   DRM_MODE=custom
  #   DRM_MODE_CUSTOM_DIR=/usr/share/gamescope-session-plus/modelines
  # fi

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=40,120
fi

# OXP X1 Devices
OXP_X1_LIST="ONEXPLAYER X1 A"
if [[ ":$OXP_X1_LIST:" =~ ":$SYS_ID:"  ]]; then
  # PANEL_TYPE=external
  ORIENTATION=left
  CUSTOM_REFRESH_RATES=60,90,120

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=60,120
fi

# OXP X1 144Hz Devices
OXP_X1_144_LIST="ONEXPLAYER X1 mini"
if [[ ":$OXP_X1_144_LIST:" =~ ":$SYS_ID:"  ]]; then
  # PANEL_TYPE=external
  ORIENTATION=left
  CUSTOM_REFRESH_RATES=60,120,144

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=60,144
fi

# AYANEO AIR, SLIDE Devices
AIR_LIST="AIR:AIR Pro:AIR Plus:SLIDE:AIR 1S:AIR 1S Limited"
if [[ ":$AIR_LIST:" =~ ":$SYS_ID:"  ]]; then
  # PANEL_TYPE=external
  ORIENTATION=left
  if lua_not_exists "ayaneo.airplus.lcd.lua"; then
      CUSTOM_REFRESH_RATES=40-60
  fi
fi

# AYANEO FLIP Dual Screen
if [[ ":FLIP DS:" =~ ":$SYS_ID:" ]]; then
  # PANEL_TYPE=external
  ORIENTATION=left
  OUTPUT_CONNECTOR='*,eDP-1,eDP-2' # prefer the top screen
fi

# AYANEO FLIP KB
if [[ ":FLIP KB:" =~ ":$SYS_ID:" ]]; then
  ORIENTATION=left
fi

# AYN Loki Devices
AYN_LIST="Loki Max:Loki Zero:Loki MiniPro"
if [[ ":$AYN_LIST:" =~ ":$SYS_ID:"  ]]; then
  DRM_MODE=fixed
  ORIENTATION=left
  CUSTOM_REFRESH_RATES=40-60

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=40,60
fi

# GDP Win devices
GDP_LIST="G1619-01:G1621-02:MicroPC:WIN2"
if [[ ":$GDP_LIST:" =~ ":$SYS_ID:"  ]]; then
  OUTPUT_CONNECTOR='*,DSI-1'
  DRM_MODE=fixed
  ORIENTATION=right
fi

# GPD Win 3 specifc quirk to prevent crashing
  # The GPD Win 3 does not support hardware rotation for 270/90 modes. We need to implement shader rotations to get this working correctly.
  # 0/180 rotations should work.
if [[ ":G1618-03:" =~ ":$SYS_ID:"  ]]; then
  OUTPUT_CONNECTOR='*,DSI-1'
  DRM_MODE=fixed
  ORIENTATION=right
fi

#GPD Win 4 supports 40-60hz refresh rate changing
if [[ ":G1618-04:" =~ ":$SYS_ID:"  ]]; then
  if lua_not_exists "gpd.win4.lcd.lua"; then
      CUSTOM_REFRESH_RATES=40-60
  fi
  export STEAM_DISPLAY_REFRESH_LIMITS=40,60
fi

# GPD Win Max 2 supports 40,60hz
if [[ ":G1619-04:" =~ ":$SYS_ID:"  ]]; then
  CUSTOM_REFRESH_RATES=40-60
  export STEAM_DISPLAY_REFRESH_LIMITS=40,60

  # Pointer options
  GAMESCOPE_TAP_TO_CLICK=1
  # GAMESCOPE_TAP_AND_DRAG=1
  GAMESCOPE_TAP_DRAG_LOCK=1
  GAMESCOPE_NATURAL_SCROLL=touchpad
fi

# GPD Win mini
if [[ ":G1617-01:" =~ ":$SYS_ID:"  ]]; then
  # ORIENTATION=""
  # if ( xrandr --prop 2>$1 | grep -e "1080x1920 " > /dev/null ) ; then
  #   ORIENTATION=right
  #   DRM_MODE=custom
  #   DRM_MODE_CUSTOM_DIR=/usr/share/gamescope-session-plus/modelines
  # else
  #   CUSTOM_REFRESH_RATES=60,70,80,90,100,110,120
  #   ORIENTATION=normal
  # fi
  
  model_name=$(cat /sys/class/drm/card*-eDP-1/edid | parse-edid 2>/dev/null | grep "ModelName" | cut -d \" -f 2 | sed 's/[^a-zA-Z0-9_-]//g')
  echo "Model Name: [$model_name]" | systemd-cat -t gamescope-session

  # xrandr --prop 2>$1 | grep -e "1080x1920 " > /dev/null
  if [[ "$model_name" == "MINI" ]] || ( xrandr --prop 2>$1 | grep -e "1080x1920 " > /dev/null ) ; then
    # model_name is "MINI"
    ORIENTATION=right
    if lua_not_exists "gpd.winmini.lcd.lua"; then
        DRM_MODE=custom
        DRM_MODE_CUSTOM_DIR=/usr/share/gamescope-session-plus/modelines
    fi
  else
    # model_name is "TL070FVXS01-0"
    ADAPTIVE_SYNC=1
    ORIENTATION=normal
    if [[ "$model_name" == "" ]] || lua_not_exists "asus.rogally.lcd.lua"; then
        CUSTOM_REFRESH_RATES="60,70,80,90,100,110,120"
    fi
  fi

  # Pointer options
  GAMESCOPE_TAP_TO_CLICK=1
  # GAMESCOPE_TAP_AND_DRAG=1
  GAMESCOPE_TAP_DRAG_LOCK=1
  GAMESCOPE_NATURAL_SCROLL=touchpad
fi

# Steam Deck (Common)
if [[ ":Jupiter:Galileo:" =~ ":$SYS_ID:" ]]; then
  DRM_MODE=fixed
  DONT_BYPASS_RESOLUTION=1

  # Enables the adaptive brightness toggle
  export STEAM_ENABLE_DYNAMIC_BACKLIGHT=1
  # Allows the fan controller service to be toggled from gamemode
  export STEAM_ENABLE_FAN_CONTROL=1
  # Sets CPU topology for Steam Deck hardware
  export WINE_CPU_TOPOLOGY=8:0,1,2,3,4,5,6,7

  # Prevent default power button behavior
  systemd-inhibit --what=handle-suspend-key:handle-power-key:handle-hibernate-key --who=gamescope-session --why="gamescope-session handles power button events" sleep infinity &

  # Start SteamOS's power button handler daemon, this passes power button events to Steam.
  if command -v /usr/bin/powerbuttond > /dev/null; then
    (while true; do
      /usr/bin/powerbuttond
    done) &
  elif [ -f /usr/lib/hwsupport/power-button-handler.py ]; then
    (while true; do
      /usr/bin/python3 /usr/lib/hwsupport/power-button-handler.py
    done) &
  fi
fi

# Steam Deck (LCD)
if [[ ":Jupiter:" =~ ":$SYS_ID:" ]]; then
  export STEAM_DISPLAY_REFRESH_LIMITS=40,60

  if [ -f "/usr/share/plymouth/themes/steamos/steamos-jupiter.png" ]; then
    export STEAM_UPDATEUI_PNG_BACKGROUND=/usr/share/plymouth/themes/steamos/steamos-jupiter.png
  fi
fi

# Steam Deck (OLED)
if [[ ":Galileo:" =~ ":$SYS_ID:" ]]; then
  export STEAM_DISPLAY_REFRESH_LIMITS=45,90

  export STEAM_GAMESCOPE_FORCE_HDR_DEFAULT=1
  export STEAM_GAMESCOPE_FORCE_OUTPUT_TO_HDR10PQ_DEFAULT=1
  export STEAM_ENABLE_STATUS_LED_BRIGHTNESS=1

  if [ -f "/usr/share/plymouth/themes/steamos/steamos-galileo.png" ]; then
    export STEAM_UPDATEUI_PNG_BACKGROUND=/usr/share/plymouth/themes/steamos/steamos-galileo.png
  fi
fi

# ROG Ally & ROG Ally X
ALLY_LIST="ROG Ally RC71L_RC71L:ROG Ally RC71L:ROG Ally X RC72LA"
if [[ ":$ALLY_LIST:" =~ ":$SYS_ID:"  ]]; then
  # PANEL_TYPE=external
  ADAPTIVE_SYNC=1
  # CUSTOM_REFRESH_RATES=60,70,80,90,100,110,120
  if lua_not_exists "asus.rogally.lcd.lua"; then
      CUSTOM_REFRESH_RATES="60,70,80,90,100,110,120"
  fi

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=40,120
fi

# Lenovo Legion Go
if [[ ":83E1:" =~ ":$SYS_ID:"  ]]; then
  ORIENTATION=left
  if lua_not_exists "lenovo.legiongo.lcd.lua"; then
      CUSTOM_REFRESH_RATES=60,90,120,144
  fi

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=60,144
fi

# Minisforum V3
if [[ ":V3:" =~ ":$SYS_ID:"  ]]; then
  # PANEL_TYPE=external
  ADAPTIVE_SYNC=1
  CUSTOM_REFRESH_RATES=60,90,100,120,144,165

  # Pointer options
  GAMESCOPE_TAP_TO_CLICK=1
  # GAMESCOPE_TAP_AND_DRAG=1
  GAMESCOPE_TAP_DRAG_LOCK=1
  GAMESCOPE_NATURAL_SCROLL=touchpad
  GAMESCOPE_TOUCH_GESTURES=1

  # Set refresh rate range and enable refresh rate switching
  export STEAM_DISPLAY_REFRESH_LIMITS=36,165
fi
